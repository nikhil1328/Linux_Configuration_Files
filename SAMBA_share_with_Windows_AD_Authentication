Accessing SAMBA share with Windows AD authentication.

SAMBA :: Samba is an open-source software suite that runs on Unix/Linux based platforms but is able to communicate with Windows clients like a native application. 
So Samba is able to provide this service by employing the Common Internet File System (CIFS). Here we will be configuring SAMBA share in a way that it will use Windows Active Directory for Authentication rather than regular SAMBA users.



1: Install Packages -
# yum install ntp krb5-user krb5* samba-* smb* smbclient winbind



2: Configure NTP 
# ntpdate <Active directory NTP server IP Address>



3: Configure DNS
Edit  /etc/resolv.conf file and change the DNS to your Active Directory DNS servers:
#vim /etc/resolve.conf
nameserver <nameserver ip address >
search FQDN(abc.xyz.com)


eg::
nameserver X.X.X.X
nameserver X.X.X.X
search abc.xyz.com



4: Configure Kerberos
# vim /etc/krb5.conf


[libdefaults]
 
	default_realm = ABC.XYZ.COM
	ticket_lifetime = 24h
	forwardable = true



[realms]

 
	XYZ.COM = 
	{
  kdc = ABC.XYZ.COM 
	default_domain = XYZ.COM
	}
 	ABC.XYZ.COM = 
	{	
  kdc = ABC.XYZ.COM
	}

[domain_realm]
  
	.xyz.com = XYZ.COM
   xyz.com = XYZ.COM

[kdc]
  
	profile = /etc/krb5kdc/kdc.conf

[appdefaults]
  
	pam = {    
	debug = false
	ticket_lifetime = 36000
	renew_lifetime = 36000
  forwardable = true
	krb4_convert = false
	}


[logging]
  
	kdc = FILE:/var/log/krb5kdc.log
	admin_server = FILE:/var/log/kadmin.log
	default = FILE:/var/log/krb5lib.log



5: Test Kerberos  :Make sure you have access to a user with admin rights.
# kinit administrator  //or any other user with admin rights
Password for Administrator@ABC.XYZ.COM



6: Check if we got a valid ticket:
# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: user@ABC.XYZ.COM


Valid starting       Expires              Service principal
07/10/2017 16:07:43  07/11/2017 02:07:43  krbtgt/ABC.XYZ.COM@ABC.XYZ.COM
renew until 07/11/2017 16:07:37



7: Configure nsswitch
Edit the entries of passwd,shadow and group as mentioned below:

#vim /etc/nsswitch.conf
passwd:     files  winbind
shadow:     files  winbind
group:      files  winbind



8: Configure Samba

#vim /etc/samba/smb.conf

[global]
#--authconfig--start-line--
# Generated by authconfig on 2017/08/22 11:06:41
# DO NOT EDIT THIS SECTION (delimited by --start-line--/--end-line--)
# Any modification may be deleted or altered by authconfig in future

   workgroup = ABC
   realm = ABC.XYZ.COM
   security = ads
   idmap config * : range = 16777216-33554431
   template homedir = /home/%D/%U
   template shell = /bin/bash
   kerberos method = secrets only
   winbind use default domain = true
   winbind offline logon = true

#--authconfig--end-line--

        local master =  no
        preferred master = no
        printcap name = /etc/printcap
        load printers = no
        idmap config ABC:backend = rid
        idmap config ABC:range = 10000-9999
        winbind enum users = yes
        winbind enum groups = yes
        winbind nested groups = yes
        winbind refresh tickets = yes
        restrict anonymous = 2
        log file = /var/log/samba/samba.log
        log level =2


########## share Configuration ###########

[Share_One]
        comment = Music 
        path = /data/samba_share/music/
        valid users = ABC\user1,ABC\user3,ABC\user2,ABC\user5,ABC\user4,ABC\user6
        public = no
        writable = yes
        create mask = 0777
        directory mask = 0777

#Note: The above users are Windows active directory users. All users are having read and write permission in "music share" 


[Share_Two]
        comment = Songs
        path = /data/smaba_share/songs/
        write list  = ABC\user1,ABC\user3,ABC\user2
        read list   = ABC\user11,ABC\user81,ABC\suer10,ABC\user14
        public      = no

#Note: The Write_list users are only the users with write access on files and folders which is inside "songs" directory. read_list users are only having read access, they wont be able to make any changes into "songs" direcotry.


#### for a specific group ######


[Share_Three]
        comment = Videos
        path = /data/smaba_share/videos/
        valid users = "+domain_group_name"
        writable = yes
    	read only = no
    	create mask = 0777
    	directory mask = 0777




9: Restart all the daemons
#systemctl restart wenbind.service
#systemctl restart nmb.service
#systemctl restart smb.service



10:  Join the domain
#net ads join -U administrator (or other user id with admin rights)

output should be::
Enter Administrator's password:
Using short domain name -- EXAMPLE
Joined 'HOSTNAME' to realm 'XYZ.COM'



11: Restart all the daemons again:
#systemctl restart winbind.service
#systemctl restart nmb.service
#systemctl restart smb.service




12: Lists all the users in the domain
#wbinfo -u
must list all the users present in the Domain



13: Lists all the groups in the domain.
#wbinfo -g
must list all the groups present in the Domain




14: Check if winbind and nsswitch are correctly working.
#getent passwd
should return a list with all users on the local system and from the active directory




15: Check if winbind and nsswitch are correctly working.
#getent group
should return a list with all groups on the local system and from the active directory


NOTE::: If this does not work, go back to the nsswitch configuration section and change the entry of "files" to "compat". 
Eg.
#vim /etc/nsswitch.conf
passwd:     compat  winbind
shadow:     compat  winbind
group:      compat  winbind




16: Configure Samba Shares
#mkdir -p /data/samba_share{music,songs,videos}
#chmod -R 0770 /data/samba_share/
#chgrp -R "Domain Users" /data/samba_share/




17: Restart the samba service.
#systemctl restart smb.service



18: Test it.

Go to Windows system. Press Ctrl+r, give path eg \\xxx.xxx.xxx.xxx\sharename. Provide valid username and password and access the share. OR
Go to this PC -> click on computer tab -> map network drive -> provide IP and Share details in folder text field.  
eg.  \\X.X.X.X\songs\ 







Nikhil Narendra Kulkarni
